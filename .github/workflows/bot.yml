name: Run bot

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
    paths:
      - "user_interface.py"

jobs:
  main-bot:
    name: Run chry
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Python Dependency Installation
        uses: py-actions/py-dependency-install@v4.1.0
      - name: Injection For my Repo
        run: sed -i "s/TokenTimeIsBackBuddyss/${{ secrets.LICHESS_KEY }}/g" config.yml
      - name: Stockfish
        run: chmod +x ./engines/stockfish-ubuntu-x86-64-bmi2 ./engines/fairy-stockfish_x86-64-bmi2 ./engines/stockfish-7-x64-bmi2
      - name: Running bot
        run: |
          python -u user_interface.py "matchmaking" "join dark-on-teams" "tournament Kqul9pAe" "tournament lrFVSZ51 real-humans" &
          PID=$!
          # Auto-exit before GitHub 6h limit
          ( sleep 20700 && echo "Time up. Killing bot..." && kill -SIGTERM $PID ) &
          wait $PID
          echo "Bot ended cleanly."
        
      - name: üîÅ Self-Restart
        if: always()
        run: gh workflow run bot.yml
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

